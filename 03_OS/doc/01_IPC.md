PC (Inter Process Communication) - 프로세스간 통신

리눅스 커널 구조에서 Process는 완전히 독립된 실행 객체이다. 이는 다른 프로세스의 영향을 받지 않는다는 장점이 있다. 그러나 독립되어 있는 만큼 서로 간 통신이 어렵다는 문제가 발생한다.

이를 위해 커널 영역에서 IPC라는 내부 프로세스 간 통신 (IPC)를 제공하게 되고, 프로세스는 커널이 제공하는 IPC를 통해 프로세스 간 통신을 할 수 있게 된다.

**IPC의 표준 (System V IPC와 POSIX IPC)**
System V IPC는 오래된 버전이고 POSIX IPC는 비교적 최근에 개발된 표준이다. System V IPC는 오랜 역사를 가진 만큼 이기종간 코드 호환성을 확실히 보장하지만 API가 오래되어 함수명이 명확하지 않다. 그에 반에 POSIX IPC는 직관적인 API로 구성되어 상대적으로 조금 더 사용하기 쉽다

### IPC 종류

현실에서도 필요에 따라 다양한 통신 설비가 존재하는 것 처럼 IPC에도 다양한 설비들이 존재한다. 각각의 필요에 따라서 적당한 통신 설비들이 준비되어야 하는 것과 마찬가지로 IPC동 상황에 맞는 IPC를 선택할 필요가 있다.

상황에 맞는 IPC 선택은 특히 fork()를 이용해서 만들어진 멀티 프로세스의 프로그램에서 중요하다. 잘못된 IPC의 선택은 코딩 과정을 어렵게 만들거나, 프로그램의 작동을 효율적이지 못하게 만들 수 있다.


#### 1. 익명 PIPE (Anonymouse PIPE)

파이프는 두 개의 프로세스를 연결하게 되고, 하나의 프로세스는 데이터를 쓰기만 다른 하나는 데이터를 읽기만 할 수 있다. 한쪽 방향으로만 통신이 가능한 특징 때문에 Half-Duplex (반이중) 통신이라고 부르기도 한다.

PIPE와 같은 반이중 통신의 경우 하나의 통신선로는 읽기나 쓰기 중 하나만 가능하므로, 읽기와 쓰기 송/수신을 모두 하려면 파이프 두 개를 만들어야 한다.

PIPE는 매우 간단하게 사용할 수 있다는 장점이 있다. 만약 한 쪽 프로세스가 단지 읽기만 하고, 다른 쪽 프로세스는 단지 쓰기만 하는, 단순한 데이터 흐름을 가진다면 PIPE가 효율적이다. 하지만 반대로 전이중 통신을 고려한다면 PIPE는 좋은 선택이 아닐 것 이다.


#### 2. Named PIPE (FIFO)

Anonymouse PIPE는 통신할 프로세스를 명확하게 알 수 있는 경우 사용한다. (ex. 자식 - 부모 프로세스 간 통신) 반대로 Named PIPE는 전혀 모르는 상태의 프로세스들 사이의 통신의 경우 사용한다. 
익명 파이프 (PIPE)의 단점으로 같은 PPID를 가지느 프로세스 사이에서만 통신이 가능하지만 Named PIPE는 부모 프로세스와 무관하게 전혀 다른 모든 프로세스들 사이에 통신이 가능하다. 그 이유는 프로세스 통신을 위해 이름이 있는 파일을 사용하기 때문이다. Named PIPE의 생성은 mkfifo를 통해 이루어지는 mkfifo가 성공하면 명명된 파일이 생성된다.

단점으로는, Named PIPE도 PIPE의 또 다른 단점인 전이중 통신이 가능하지 않으며, read-only / write-only만 가능하다.


#### 3. Message Queue

Queue는 선입 선출의 자료구조를 가지는 통신설비로 커널에서 관리된다. 입출력 방식으로 따지면 Named PIPE와 유사해보이지만, 큐는 Memory공간을 사용한다는 차이점이 있다. 즉 파이프가 아닌 어디에서나 꺼낼 수 있는 컨테이너 밸트라고 이해하면 편할 것 같다.

메시지 큐의 장점은 메시지 큐에 쓸 데이터에 번호를 붙여 관리함으로써 여러개의 프로세스가 동신에 데이터를 쉽게 다룰 수 있도록 한다.


#### 4. Shared Memory

데이터를 공유하는 방법에는 크게 두 가지가 있다. 
1. 통신을 이용해서 데이터를 주고 받는 것 
2. 데이터를 공유하여 함께 사용하는 것

프로세스는 자신만의 메모리 영역을 가지고 있다. 이 메모리 영역은 다른 프로세스가 접근해서 함부로 사용하지 못하도록 보호된다. 만약 다른 프로세스가 메모리 영역을 침범하려고 하면 SIGSEGV 시그널을 보내게 된다.

다수의 파로세스가 동시에 동작하는 Linux OS 특성상 프로세스의 메모리 영역은 반드시 보호되어야 한다. 하지만 메모리 영역에 있는 데이터를 다른 프로세스도 사용해야 하는 경우도 있을 것이다. Thread처럼 메모리 영역을 공유한다면 더 편하게 데이터를 함께 다룰 수 있을 것이다.

Shared Memory(공유 메모리)는 프로세스간 메모리 영역을 공유해서 사용할 수 있도록 허용한다. 프로세스가 공유메모리 할당을 커널에 요청하면 커널은 해당 메모리 공간을 할당해준다. 이후 어떤 프로세스건 해당 메모리 영역에 접근할 수 있게 된다.

공유 메모리는 중개자 없이 곧바로 메모리에 접근할 수 있기 때문에 모든 IPC 중에서 가장 빠르게 동작할 수 있다.


#### 5. Memory Map

Memory Map도 Shared Memory 공간과 마찬가지로 메모리를 공유한다는 측면에서 서로 비슷한 측면이 있다. 차이점은 Memory Map은 열린 파일을 메모리에 맵핑시켜서 공유한다는 점이다. 파일은 시스템의 전역적인 자원이므로, 서로 다른 프로세스 들끼리 데이터를 공유하는데 문제가 없을 것임을 알 수 있다.


#### 6. Socket 

Socket은 프로세스와 시스템의 기초적인 부분이며, 프로세스 들 사이의 통신을 가능하게 한다. <sys/socket.h>라는 헤더를 이용하여 사용할 수 있으며, 같은 도메인엥서의 경우 연결될 수 있다. 

서버단에서는 bind, listen, accpet를 해주어 소켓 연결을 위한 준비를 해야 하고, 클라이언트 단에서는 connect를 통해 서버에 요청하며 연결이 수립된 이후에는 Socket send를 함으로써 데이터를 주고 받게 된다.

#### 7. Semaphore

Named PIPE, PIPE, Message Queue와 같은 IPC 설비들이 대부분 프로세스 간 메시지 전송을 목적으로 한다. 그에 반해, Semaphore는 프로세스 간 데이터를 동기화 하고 보호하는데 그 목적을 두게 된다.

Shared Memory와 같이 특정 데이터를 공유해서 사용하게 될 경우, 공유된 자원에 여러 프로세스가 동시에 접근하면 안되는데, 이때 사용되는 것이 Semaphore이다.

#### 번외. Mutex vs Semaphore

세마포어 (Semaphore): 공유된 자원의 데이터 혹은 임계영역(Ciritical Section) 등에 여러 Process 혹은 Thread가 접근하는 것을 막아줌 (즉, 동기화 대상이 하나 이상인 것)
* 해당 공유 자원을 다른 프로세스가 사용하고 있다고 표시
* 다른 프로세스가 해당 값을 확인하여 자원 점유가 풀리기를 기다리도록 하는 방법
* 공유 변수(S)를 사용하여 프로세스의 자원 점유(1)와 비점유(0)을 사용함

공유변수: 초기값은 1로, 상호배제를 위해 공유되는 변수
P 연산: 공유 변수를 0으로 만들어 다른 프로세스가 들어오지 못하게 함
V 연산: 공유 번수를 1로 만들어 다른 프로세스가 간섭할 수 있도록 함

위 연산들을 통해 아래오 같이 임계 영역을 생성한다.
P(S);
------임계영역------
V(S);

뮤텍스 (Mutex): 공유된 자원의 데이터 혹은 임계영역 (Ciritical Section)등에 하나의 Process 혹은 Thread가 접근하는 것을 막아줌 (즉, 동기화 대상이 하나)
* Ciritical Section을 가진 Thread 들의 Running Time이 겹치지 않고 각각 단독으로 실행하게 하는 기술
* 조율을 위해 Locking, Unlocking을 사용함



Critical Section이란?
다중 프로그래밍 운영체제에서 여러 프로세스가 데이터를 공유하면서 수행될 때, 각 프로세스에서 공유 데이터를 접근 (Access)하는 프로그램 코드 부분을 가리키는 말이다.

공유데이터를 여러 프로세스가 동시에 접근하면 시간적 차이등으로 인하여 잘못된 결과를 만들어 낼 수 있기 때문에 한 프로세스가 공유데이터를 액세스하고 있을 때는 다른 프로세스들은 절 대로 그 데이터에 액세스하지 못하도록 해야 한다.

다중 프로그래밍 시스템에서는 프로세스들 간의 상호배제와 동기화를 위한 기본적인 연산이 필요하게 되고, 세마포어는 여러 프로세스들에 의해 공유되는 변수로 정의된다.
해당 변수는 통상적인 방법으로 접근할 수 없고 오직 P, V 연산을 통해 조작된다.




출처: https://jwprogramming.tistory.com/54
